#!/bin/bash
source setup.sh

# VARIABLES
PROJECT_PATH="/tmp/ghidra-batch2"
mkdir "${PROJECT_PATH}"
PROJECT_NAME="MalwareBatch"
SCRIPT="ghidra_scripts/ghidra-functions-to-MISP.py"
SEARCH_DIR="/home/test/test/MALWARE/malware-dataset/linux/"

# 1. Collect the samples using your find command
echo "[+] Searching for samples..."
SAMPLES=($(find "$SEARCH_DIR" -type f -regextype sed -regex ".*/\([a-f0-9]\{64\}\)/\1$"))

echo "[+] Found ${#SAMPLES[@]} samples."

# 2. Build the -import arguments
IMPORT_ARGS=()
for sample in "${SAMPLES[@]}"; do
    IMPORT_ARGS+=("-import" "$sample")
done

# 3. Execute analyzeHeadless (or pyghidraRun --headless)
# We use -overwrite to ensure a fresh import if the project exists
pyghidraRun --headless "$PROJECT_PATH" "$PROJECT_NAME" \
    "${IMPORT_ARGS[@]}" \
    -noanalysis \
    -overwrite \
    -postScript "$SCRIPT" \
    --all-functions \
    --verbose \
    --name-exclude "^_" \
    --min-blocks 5 \
    --ignore thunks \
    --extend-event
